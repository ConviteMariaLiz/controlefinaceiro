<script>
        // --- 1. ESTADO DA APLICAÇÃO ---
        let entradas = JSON.parse(localStorage.getItem('entradas')) || [];
        let saidas = JSON.parse(localStorage.getItem('saidas')) || [];
        let metas = JSON.parse(localStorage.getItem('metas')) || [];
        let categoriasSaidas = JSON.parse(localStorage.getItem('categoriasSaidas')) || ['Alimentação', 'Transporte', 'Lazer', 'Saúde', 'Educação', 'Casa', 'Tecnologia', 'Outros'];

        let chartCategorias = null;
        let chartEconomia = null;

        // --- 2. INICIALIZAÇÃO ---
        window.onload = () => {
            updateCategoriasDropdown();
            atualizarInterface();
            setupEventListeners();
            showSection('dashboard');
        };

        function setupEventListeners() {
            // Navegação
            const navMap = {
                'btn-dashboard': 'dashboard',
                'btn-entradas': 'entradas',
                'btn-saidas': 'saidas',
                'btn-metas': 'metas',
                'btn-relatorios': 'relatorios'
            };

            Object.entries(navMap).forEach(([btnId, sectionId]) => {
                document.getElementById(btnId).onclick = () => showSection(sectionId);
            });

            // Modais
            document.getElementById('btn-add-entrada').onclick = () => toggleModal('modal-entrada', true);
            document.getElementById('btn-close-modal-entrada').onclick = () => toggleModal('modal-entrada', false);
            document.getElementById('btn-add-saida').onclick = () => toggleModal('modal-saida', true);
            document.getElementById('btn-close-modal-saida').onclick = () => toggleModal('modal-saida', false);

            // Formulários
            setupForm('form-entrada', 'valor-entrada', 'fonte-entrada', 'data-entrada', 'entrada');
            setupForm('form-entrada-modal', 'valor-entrada-modal', 'fonte-entrada-modal', 'data-entrada-modal', 'entrada', true);
            
            setupFormSaida('form-saida', 'valor-saida', 'categoria-saida', 'nova-categoria-saida', 'data-saida');
            setupFormSaida('form-saida-modal', 'valor-saida-modal', 'categoria-saida-modal', 'nova-categoria-saida-modal', 'data-saida-modal', true);

            document.getElementById('form-meta').onsubmit = salvarMeta;

            // Filtros e Relatórios
            document.getElementById('btn-filtrar-entradas').onclick = () => renderListaEntradas();
            document.getElementById('btn-filtrar-saidas').onclick = () => renderListaSaidas();
            document.getElementById('btn-gerar-relatorio').onclick = gerarRelatorio;
            document.getElementById('btn-baixar-relatorio').onclick = baixarCSV;
        }

        // --- 3. LÓGICA DE INTERFACE ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'dashboard') renderCharts();
        }

        function toggleModal(id, show) {
            document.getElementById(id).classList.toggle('hidden', !show);
        }

        function updateCategoriasDropdown() {
            const options = '<option value="">Selecione</option>' + 
                categoriasSaidas.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            document.getElementById('categoria-saida').innerHTML = options;
            document.getElementById('categoria-saida-modal').innerHTML = options;
        }

        // --- 4. LÓGICA DE DADOS (SALVAMENTO) ---
        function setupForm(formId, valId, catId, dateId, type, isModal = false) {
            document.getElementById(formId).onsubmit = (e) => {
                e.preventDefault();
                const item = {
                    id: Date.now(),
                    valor: parseFloat(document.getElementById(valId).value),
                    categoria: document.getElementById(catId).value,
                    data: document.getElementById(dateId).value
                };
                entradas.push(item);
                saveAndRefresh();
                e.target.reset();
                if(isModal) toggleModal('modal-entrada', false);
            };
        }

        function setupFormSaida(formId, valId, catId, newCatId, dateId, isModal = false) {
            document.getElementById(formId).onsubmit = (e) => {
                e.preventDefault();
                let categoria = document.getElementById(catId).value;
                const nova = document.getElementById(newCatId).value;

                if (nova) {
                    categoria = nova;
                    if (!categoriasSaidas.includes(nova)) {
                        categoriasSaidas.push(nova);
                        updateCategoriasDropdown();
                    }
                }

                saidas.push({
                    id: Date.now(),
                    valor: parseFloat(document.getElementById(valId).value),
                    categoria: categoria,
                    data: document.getElementById(dateId).value
                });
                saveAndRefresh();
                e.target.reset();
                if(isModal) toggleModal('modal-saida', false);
            };
        }

        function salvarMeta(e) {
            e.preventDefault();
            metas.push({
                id: Date.now(),
                valor: parseFloat(document.getElementById('meta-valor').value),
                descricao: document.getElementById('meta-descricao').value
            });
            saveAndRefresh();
            e.target.reset();
        }

        function saveAndRefresh() {
            localStorage.setItem('entradas', JSON.stringify(entradas));
            localStorage.setItem('saidas', JSON.stringify(saidas));
            localStorage.setItem('metas', JSON.stringify(metas));
            localStorage.setItem('categoriasSaidas', JSON.stringify(categoriasSaidas));
            atualizarInterface();
        }

        // --- 5. RENDERIZAÇÃO E CÁLCULOS ---
        function atualizarInterface() {
            const agora = new Date();
            const mesAtual = agora.toISOString().substring(0, 7); // YYYY-MM

            const totalEntradas = entradas.reduce((acc, v) => acc + v.valor, 0);
            const totalSaidas = saidas.reduce((acc, v) => acc + v.valor, 0);
            
            const entMes = entradas.filter(e => e.data.startsWith(mesAtual)).reduce((acc, v) => acc + v.valor, 0);
            const saiMes = saidas.filter(s => s.data.startsWith(mesAtual)).reduce((acc, v) => acc + v.valor, 0);

            document.getElementById('economia-atual').innerText = `R$ ${(totalEntradas - totalSaidas).toLocaleString('pt-BR')}`;
            document.getElementById('entradas-mes').innerText = `R$ ${entMes.toLocaleString('pt-BR')}`;
            document.getElementById('saidas-mes').innerText = `R$ ${saiMes.toLocaleString('pt-BR')}`;

            renderListaEntradas();
            renderListaSaidas();
            renderMetas();
            if(!document.getElementById('dashboard').classList.contains('hidden')) renderCharts();
        }

        function renderListaEntradas() {
            const filtro = document.getElementById('filtro-entradas').value;
            const lista = document.getElementById('historico-entradas');
            const dados = filtro ? entradas.filter(e => e.data.startsWith(filtro)) : entradas;
            
            lista.innerHTML = dados.map(e => `
                <li class="flex justify-between border-b py-2">
                    <span>${e.data.split('-').reverse().join('/')} - ${e.categoria}</span>
                    <span class="text-blue-600 font-bold">+ R$ ${e.valor.toFixed(2)}</span>
                </li>
            `).join('') || '<p class="text-gray-400">Nenhum registro encontrado.</p>';
        }

        function renderListaSaidas() {
            const filtro = document.getElementById('filtro-saidas').value;
            const lista = document.getElementById('historico-saidas');
            const dados = filtro ? saidas.filter(s => s.data.startsWith(filtro)) : saidas;

            lista.innerHTML = dados.map(s => `
                <li class="flex justify-between border-b py-2">
                    <span>${s.data.split('-').reverse().join('/')} - ${s.categoria}</span>
                    <span class="text-red-600 font-bold">- R$ ${s.valor.toFixed(2)}</span>
                </li>
            `).join('') || '<p class="text-gray-400">Nenhum registro encontrado.</p>';
        }

        function renderMetas() {
            const totalEconomizado = entradas.reduce((acc, v) => acc + v.valor, 0) - saidas.reduce((acc, v) => acc + v.valor, 0);
            const html = metas.map(m => {
                const perc = Math.min((totalEconomizado / m.valor) * 100, 100).toFixed(0);
                return `
                    <div class="mb-4">
                        <div class="flex justify-between mb-1">
                            <span>${m.descricao} (Meta: R$ ${m.valor})</span>
                            <span>${perc}%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${perc}%"></div></div>
                    </div>
                `;
            }).join('');
            document.getElementById('metas-lista').innerHTML = html;
            document.getElementById('metas-salvas').innerHTML = html;
        }

        // --- 6. GRÁFICOS (CHART.JS) ---
        function renderCharts() {
            const ctxCat = document.getElementById('chart-categorias').getContext('2d');
            const ctxEco = document.getElementById('chart-economia').getContext('2d');

            if(chartCategorias) chartCategorias.destroy();
            if(chartEconomia) chartEconomia.destroy();

            // Dados Categoria
            const gatosPorCat = {};
            saidas.forEach(s => gatosPorCat[s.categoria] = (gatosPorCat[s.categoria] || 0) + s.valor);

            chartCategorias = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(gatosPorCat),
                    datasets: [{ data: Object.values(gatosPorCat), backgroundColor: ['#16a34a', '#3b82f6', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899'] }]
                }
            });

            // Dados Economia (Últimos 6 meses simplificado)
            chartEconomia = new Chart(ctxEco, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                    datasets: [{ label: 'Economia', data: [0, 0, 0, 0, 0, 0], borderColor: '#16a34a', fill: true }]
                }
            });
        }

        // --- 7. RELATÓRIOS ---
        function gerarRelatorio() {
            const periodo = document.getElementById('periodo-relatorio').value;
            if(!periodo) return alert("Selecione um mês!");
            
            const ePer = entradas.filter(e => e.data.startsWith(periodo)).reduce((acc, v) => acc + v.valor, 0);
            const sPer = saidas.filter(s => s.data.startsWith(periodo)).reduce((acc, v) => acc + v.valor, 0);
            
            document.getElementById('relatorio-conteudo').innerHTML = `
                <div class="p-4 bg-gray-50 rounded">
                    <p>Total Recebido: <strong class="text-blue-600">R$ ${ePer.toFixed(2)}</strong></p>
                    <p>Total Gasto: <strong class="text-red-600">R$ ${sPer.toFixed(2)}</strong></p>
                    <hr class="my-2">
                    <p>Saldo do Período: <strong>R$ ${(ePer - sPer).toFixed(2)}</strong></p>
                </div>
            `;
        }

        function baixarCSV() {
            let csv = "Tipo;Data;Descricao;Valor\n";
            entradas.forEach(e => csv += `Entrada;${e.data};${e.categoria};${e.valor}\n`);
            saidas.forEach(s => csv += `Saida;${s.data};${s.categoria};${s.valor}\n`);
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'relatorio_financeiro.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
