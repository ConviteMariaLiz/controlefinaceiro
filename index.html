// Dados armazenados localmente
let entradas = JSON.parse(localStorage.getItem('entradas')) || [];
let saidas = JSON.parse(localStorage.getItem('saidas')) || [];
let investimentos = JSON.parse(localStorage.getItem('investimentos')) || [];

// Função de log para depuração
function log(message) {
    console.log('[Controle Financeiro]', message);
}

// Navegação
document.getElementById('btn-dashboard').addEventListener('click', () => showSection('dashboard'));
document.getElementById('btn-entradas').addEventListener('click', () => showSection('entradas'));
document.getElementById('btn-saidas').addEventListener('click', () => showSection('saidas'));
document.getElementById('btn-investimentos').addEventListener('click', () => showSection('investimentos'));

function showSection(sectionId) {
    log(`Mostrando seção: ${sectionId}`);
    document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
    document.getElementById(sectionId).classList.remove('hidden');
    if (sectionId === 'dashboard') updateDashboard();
}

// Formulários
document.getElementById('form-entrada').addEventListener('submit', (e) => {
    e.preventDefault();
    log('Tentando salvar entrada');
    try {
        const entrada = {
            valor: parseFloat(document.getElementById('valor-entrada').value),
            fonte: document.getElementById('fonte-entrada').value,
            data: document.getElementById('data-entrada').value
        };
        if (!entrada.valor || !entrada.fonte || !entrada.data) throw new Error('Campos obrigatórios faltando');
        entradas.push(entrada);
        localStorage.setItem('entradas', JSON.stringify(entradas));
        updateHistorico('historico-entradas', entradas);
        log('Entrada salva com sucesso');
        e.target.reset();
    } catch (error) {
        log(`Erro ao salvar entrada: ${error.message}`);
        alert(`Erro: ${error.message}`);
    }
});

document.getElementById('form-saida').addEventListener('submit', (e) => {
    e.preventDefault();
    log('Tentando salvar saída');
    try {
        const saida = {
            valor: parseFloat(document.getElementById('valor-saida').value),
            categoria: document.getElementById('categoria-saida').value,
            data: document.getElementById('data-saida').value
        };
        if (!saida.valor || !saida.categoria || !saida.data) throw new Error('Campos obrigatórios faltando');
        saidas.push(saida);
        localStorage.setItem('saidas', JSON.stringify(saidas));
        updateHistorico('historico-saidas', saidas);
        log('Saída salva com sucesso');
        e.target.reset();
    } catch (error) {
        log(`Erro ao salvar saída: ${error.message}`);
        alert(`Erro: ${error.message}`);
    }
});

document.getElementById('form-investimento').addEventListener('submit', (e) => {
    e.preventDefault();
    log('Tentando salvar investimento');
    try {
        const investimento = {
            objetivo: document.getElementById('objetivo-investimento').value,
            alvo: parseFloat(document.getElementById('valor-alvo').value),
            atual: parseFloat(document.getElementById('valor-atual').value)
        };
        if (!investimento.objetivo || !investimento.alvo || isNaN(investimento.atual)) throw new Error('Campos obrigatórios faltando');
        investimentos.push(investimento);
        localStorage.setItem('investimentos', JSON.stringify(investimentos));
        updateObjetivos();
        log('Investimento salvo com sucesso');
        e.target.reset();
    } catch (error) {
        log(`Erro ao salvar investimento: ${error.message}`);
        alert(`Erro: ${error.message}`);
    }
});

// Atualizar histórico
function updateHistorico(id, lista) {
    const ul = document.getElementById(id);
    if (!ul) return log(`Elemento ${id} não encontrado`);
    ul.innerHTML = lista.map(item => `<li>${item.data}: R$ ${item.valor} - ${item.fonte || item.categoria}</li>`).join('');
    log(`Histórico ${id} atualizado`);
}

// Atualizar objetivos
function updateObjetivos() {
    const ul = document.getElementById('objetivos-salvos');
    if (!ul) return log('Elemento objetivos-salvos não encontrado');
    ul.innerHTML = investimentos.map(inv => `<li>${inv.objetivo}: R$ ${inv.atual} / R$ ${inv.alvo} (${((inv.atual / inv.alvo) * 100).toFixed(1)}%)</li>`).join('');
    const listaDashboard = document.getElementById('objetivos-lista');
    if (listaDashboard) listaDashboard.innerHTML = ul.innerHTML;
    log('Objetivos atualizados');
}

// Dashboard
function updateDashboard() {
    log('Atualizando dashboard');
    const totalEntradas = entradas.reduce((sum, e) => sum + e.valor, 0);
    const totalSaidas = saidas.reduce((sum, s) => sum + s.valor, 0);
    document.getElementById('resumo').innerHTML = `Entradas: R$ ${totalEntradas.toFixed(2)} | Saídas: R$ ${totalSaidas.toFixed(2)} | Saldo: R$ ${(totalEntradas - totalSaidas).toFixed(2)}`;

    // Gráfico de despesas por categoria
    const categorias = {};
    saidas.forEach(s => categorias[s.categoria] = (categorias[s.categoria] || 0) + s.valor);
    const ctxDespesas = document.getElementById('chart-despesas');
    if (ctxDespesas) {
        new Chart(ctxDespesas, {
            type: 'pie',
            data: {
                labels: Object.keys(categorias),
                datasets: [{ data: Object.values(categorias), backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe'] }]
            }
        });
    }

    // Gráfico de evolução
    const meses = {};
    entradas.forEach(e => {
        const mes = e.data.slice(0, 7);
        meses[mes] = meses[mes] || { entradas: 0, saidas: 0 };
        meses[mes].entradas += e.valor;
    });
    saidas.forEach(s => {
        const mes = s.data.slice(0, 7);
        meses[mes] = meses[mes] || { entradas: 0, saidas: 0 };
        meses[mes].saidas += s.valor;
    });
    const labels = Object.keys(meses).sort();
    const entradasData = labels.map(m => meses[m].entradas);
    const saidasData = labels.map(m => meses[m].saidas);
    const ctxEvolucao = document.getElementById('chart-evolucao');
    if (ctxEvolucao) {
        new Chart(ctxEvolucao, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Entradas', data: entradasData, borderColor: '#4caf50' },
                    { label: 'Saídas', data: saidasData, borderColor: '#f44336' }
                ]
            }
        });
    }

    updateObjetivos();
}

// Inicializar
log('Inicializando app');
showSection('dashboard');
updateHistorico('historico-entradas', entradas);
updateHistorico('historico-saidas', saidas);
updateObjetivos();
